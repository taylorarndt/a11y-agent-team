name: Accessibility Check

on:
  pull_request:
    branches: [main]
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.jsx"
      - "**/*.tsx"
      - "**/*.vue"
      - "**/*.svelte"
      - "**/*.css"
      - "**/*.scss"

jobs:
  a11y-lint:
    name: Accessibility Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Run accessibility lint (Node.js)
        run: node .github/scripts/a11y-lint.mjs .

      - name: Run axe-core linter
        run: |
          HTML_FILES=$(find . -name '*.html' -not -path './node_modules/*' -not -path './.git/*' -not -path './dist/*' -not -path './build/*' | head -20)
          if [ -n "$HTML_FILES" ]; then
            npx @axe-core/cli --exit --rules wcag2a,wcag2aa --disable color-contrast $HTML_FILES 2>/dev/null || true
          else
            echo "No HTML files found for axe-core scan. Skipping."
          fi
        continue-on-error: true

  eslint-a11y:
    name: ESLint jsx-a11y
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for package.json
        id: check-package
        run: |
          if [ -f package.json ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No package.json found. Skipping ESLint a11y checks."
          fi

      - name: Setup Node.js
        if: steps.check-package.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        if: steps.check-package.outputs.found == 'true'
        run: npm ci
        continue-on-error: true

      - name: Check for eslint-plugin-jsx-a11y
        id: check-plugin
        if: steps.check-package.outputs.found == 'true'
        run: |
          if grep -q 'eslint-plugin-jsx-a11y' package.json 2>/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "eslint-plugin-jsx-a11y is not installed. Consider adding it for automated accessibility linting."
          fi

      - name: Run ESLint a11y rules
        if: steps.check-plugin.outputs.found == 'true'
        run: |
          npx eslint --no-eslintrc --plugin jsx-a11y \
            --rule '{"jsx-a11y/alt-text": "error", "jsx-a11y/anchor-has-content": "error", "jsx-a11y/aria-props": "error", "jsx-a11y/aria-role": "error", "jsx-a11y/click-events-have-key-events": "warn", "jsx-a11y/heading-has-content": "error", "jsx-a11y/label-has-associated-control": "error", "jsx-a11y/no-noninteractive-element-interactions": "warn", "jsx-a11y/tabindex-no-positive": "error"}' \
            --ext .jsx,.tsx .
        continue-on-error: true
