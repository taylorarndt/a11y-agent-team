name: Sync Documentation to Site

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - 'CODE_OF_CONDUCT.md'
      - 'ROADMAP.md'
      - 'SECURITY.md'

  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    if: github.repository == 'Community-Access/accessibility-agents'
    steps:
      - name: Checkout accessibility-agents
        uses: actions/checkout@v4
        with:
          path: accessibility-agents

      - name: Checkout community-access.github.io
        uses: actions/checkout@v4
        with:
          repository: Community-Access/community-access.github.io
          path: pages-site
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}

      - name: Build docs manifest
        working-directory: accessibility-agents
        run: |
          echo '{ "generated": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "sections": [' > manifest.json

          # Getting Started
          echo '{"name":"Getting Started","id":"getting-started","items":[' >> manifest.json
          first=true
          for f in docs/getting-started.md docs/configuration.md docs/architecture.md; do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Agents
          echo '{"name":"Agents","id":"agents","items":[' >> manifest.json
          first=true
          for f in docs/agents/README.md $(find docs/agents -name '*.md' ! -name 'README.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Skills
          echo '{"name":"Skills","id":"skills","items":[' >> manifest.json
          first=true
          for f in $(find docs/skills -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Tools
          echo '{"name":"Tools","id":"tools","items":[' >> manifest.json
          first=true
          for f in $(find docs/tools -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Scanning
          echo '{"name":"Scanning","id":"scanning","items":[' >> manifest.json
          first=true
          for f in $(find docs/scanning -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Prompts: Web
          echo '{"name":"Prompts: Web","id":"prompts-web","items":[' >> manifest.json
          first=true
          for f in $(find docs/prompts/web -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Prompts: Documents
          echo '{"name":"Prompts: Documents","id":"prompts-docs","items":[' >> manifest.json
          first=true
          for f in $(find docs/prompts/documents -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Prompts: GitHub
          echo '{"name":"Prompts: GitHub","id":"prompts-github","items":[' >> manifest.json
          first=true
          for f in $(find docs/prompts/github -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Advanced
          echo '{"name":"Advanced","id":"advanced","items":[' >> manifest.json
          first=true
          for f in $(find docs/advanced -name '*.md' | sort); do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md | sed 's/-/ /g')
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']},' >> manifest.json

          # Project root files
          echo '{"name":"Project","id":"project","items":[' >> manifest.json
          first=true
          for f in README.md CONTRIBUTING.md CODE_OF_CONDUCT.md ROADMAP.md SECURITY.md; do
            if [ -f "$f" ]; then
              title=$(head -5 "$f" | grep -m1 '^#' | sed 's/^#\+ //')
              [ -z "$title" ] && title=$(basename "$f" .md)
              $first || echo ',' >> manifest.json
              echo "{\"path\":\"$f\",\"title\":\"$title\"}" >> manifest.json
              first=false
            fi
          done
          echo ']}' >> manifest.json

          echo ']}' >> manifest.json

          # Validate JSON
          python3 -m json.tool manifest.json > /dev/null

      - name: Sync docs to community-access.github.io
        run: |
          # Ensure the docs directory exists in the pages repo
          mkdir -p pages-site/docs

          # Sync docs/ tree; --delete removes stale files from the mirror
          rsync -av --delete \
            accessibility-agents/docs/ \
            pages-site/docs/

          # Copy the generated manifest
          cp accessibility-agents/manifest.json pages-site/manifest.json

          cd pages-site
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/ manifest.json
          if git diff --cached --quiet; then
            echo "Documentation unchanged â€” nothing to commit."
          else
            git commit -m "chore: sync docs from accessibility-agents [skip ci]"
            git push
          fi
